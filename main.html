<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шайтан машина</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
            font-size: 2.2em;
            text-transform: uppercase;
            letter-spacing: 3px;
            padding: 15px;
            background: linear-gradient(45deg, #1a1a1a, #363636);
            border: 2px solid #2980b9;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(41, 128, 185, 0.3),
                        inset 0 0 15px rgba(41, 128, 185, 0.2);
            text-shadow: 0 0 10px rgba(41, 128, 185, 0.5);
            position: relative;
            overflow: hidden;
        }

        h1::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(41, 128, 185, 0.3),
                transparent
            );
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }
            20% {
                left: 100%;
            }
            100% {
                left: 100%;
            }
        }

        .students-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .student-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            margin-bottom: 8px;
            background-color: #363636;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            cursor: pointer;
        }

        .student-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            background-color: #404040;
        }

        .student-item.absent {
            background-color: rgba(231, 76, 60, 0.2);
        }

        .student-item.absent .student-number {
            background-color: #c0392b;
        }

        .student-number {
            min-width: 40px;
            height: 40px;
            background-color: #2980b9;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .student-name, .student-surname {
            font-family: 'Segoe UI', sans-serif;
            font-size: 1.1em;
            font-weight: 500;
            color: #ffffff;
        }

        .student-name {
            margin-right: 8px;
        }

        .student-surname {
            margin-left: 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .student-item {
                padding: 10px 15px;
            }

            .student-number {
                min-width: 35px;
                height: 35px;
                margin-right: 15px;
            }
        }

        .random-student-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #363636;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .random-button, .new-lesson-button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            width: 100%;
        }

        .random-button:hover, .new-lesson-button:hover {
            background-color: #3498db;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .random-student-display {
            font-size: 1.3em;
            color: #ffffff;
            font-weight: 500;
            min-height: 30px;
            padding: 10px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .random-student-display .text {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .random-student-display .text.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .random-student-display .char {
            display: inline-block;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s ease forwards;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                margin: 0;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .random-student-container {
                padding: 15px;
                margin-bottom: 20px;
            }

            .random-button, .new-lesson-button {
                width: 100%;
                padding: 15px;
                font-size: 1em;
            }

            .random-student-display {
                font-size: 1.1em;
                padding: 8px;
            }

            .student-item {
                padding: 10px 15px;
                margin-bottom: 6px;
            }

            .student-number {
                min-width: 35px;
                height: 35px;
                margin-right: 12px;
                font-size: 0.9em;
            }

            .student-name, .student-surname {
                font-size: 0.95em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .random-button, .new-lesson-button {
                padding: 12px;
                font-size: 0.95em;
            }

            .student-item {
                padding: 8px 12px;
            }

            .student-number {
                min-width: 30px;
                height: 30px;
                margin-right: 10px;
            }

            .student-name, .student-surname {
                font-size: 0.9em;
            }
        }

        /* Добавляем поддержку жестов для мобильных устройств */
        @media (hover: none) {
            .student-item:hover {
                transform: none;
            }

            .random-button:hover, .new-lesson-button:hover {
                transform: none;
            }

            .student-item:active {
                background-color: #404040;
            }

            .random-button:active, .new-lesson-button:active {
                background-color: #3498db;
            }
        }

        /* Предотвращаем масштабирование на iOS при двойном тапе */
        * {
            touch-action: manipulation;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;  /* Добавляем отступ между кнопкой и списком */
        }

        .excluded-students {
            background-color: #363636;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-height: 150px;
            height: auto;
        }

        .excluded-students h2 {
            font-size: 1.3em;
            margin: 0 0 15px 0;
            color: #ffffff;
        }

        .excluded-list {
            list-style: none;
            padding: 0;
            margin: 0;
            min-height: 80px;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .excluded-item {
            background-color: #404040;
            padding: 12px 20px;
            margin-bottom: 8px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            animation: slideInWithBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            transform-origin: top;
            opacity: 0;
            max-height: 0;
            transform: translateX(-20px);
            overflow: hidden;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideInWithBounce {
            0% {
                opacity: 0;
                transform: translateX(-20px);
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-bottom: 0;
            }
            70% {
                transform: translateX(5px);
                max-height: 50px;
                padding-top: 12px;
                padding-bottom: 12px;
                margin-bottom: 8px;
            }
            100% {
                opacity: 1;
                transform: translateX(0);
                max-height: 45px;
                padding-top: 12px;
                padding-bottom: 12px;
                margin-bottom: 8px;
            }
        }

        .excluded-item.removing {
            animation: slideOutWithBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            margin-bottom: 0;
            padding-top: 0;
            padding-bottom: 0;
            max-height: 0;
            opacity: 0;
            transform: translateX(20px);
        }

        @keyframes slideOutWithBounce {
            0% {
                opacity: 1;
                transform: translateX(0);
                max-height: 45px;
                padding-top: 12px;
                padding-bottom: 12px;
                margin-bottom: 8px;
            }
            30% {
                transform: translateX(-5px);
                max-height: 50px;
            }
            100% {
                opacity: 0;
                transform: translateX(20px);
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-bottom: 0;
            }
        }

        .excluded-item span {
            font-size: 1.1em;
            flex-grow: 1;
            text-align: left;
        }

        .excluded-item button {
            background-color: #c0392b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            transition: background-color 0.2s;
        }

        .excluded-item button:hover {
            background-color: #e74c3c;
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .excluded-students {
                order: 2;
            }
        }

        .student-item.selected {
            background-color: rgba(255, 193, 7, 0.2);  /* Желтый фон для выбранных */
        }

        .student-item.selected .student-number {
            background-color: #ffc107;  /* Желтый круг с номером */
            color: #2d2d2d;  /* Темный текст для контраста */
        }

        .special-mode-banner {
            display: none !important; /* Принудительно скрываем плашку */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Шайтан машина</h1>
        
        <div class="main-layout">
            <div class="left-column">
                <div class="random-student-container">
                    <button class="random-button">Выбрать случайного ученика</button>
                    <div class="random-student-display"></div>
                </div>

                <ul class="students-list">
                    <li class="student-item">
                        <div class="student-number">1</div>
                        <span class="student-name">Алисафа</span>
                        <span class="student-surname">Алескеров</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">2</div>
                        <span class="student-name">Александр</span>
                        <span class="student-surname">Банзаков</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">3</div>
                        <span class="student-name">Роман</span>
                        <span class="student-surname">Бирфельд</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">4</div>
                        <span class="student-name">Георгий</span>
                        <span class="student-surname">Благочевский</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">5</div>
                        <span class="student-name">Артем</span>
                        <span class="student-surname">Булатов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">6</div>
                        <span class="student-name">Кирилл</span>
                        <span class="student-surname">Валуйский</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">7</div>
                        <span class="student-name">Дмитрий</span>
                        <span class="student-surname">Грибков</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">8</div>
                        <span class="student-name">Даниил</span>
                        <span class="student-surname">Данилин</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">9</div>
                        <span class="student-name">Дарий</span>
                        <span class="student-surname">Даценков</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">10</div>
                        <span class="student-name">Иван</span>
                        <span class="student-surname">Долгополов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">11</div>
                        <span class="student-name">Вячеслав</span>
                        <span class="student-surname">Домнин</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">12</div>
                        <span class="student-name">Ярослав</span>
                        <span class="student-surname">Дроздов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">13</div>
                        <span class="student-name">Полина</span>
                        <span class="student-surname">Егорова</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">14</div>
                        <span class="student-name">Дарья</span>
                        <span class="student-surname">Жердева</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">15</div>
                        <span class="student-name">Илья</span>
                        <span class="student-surname">Изразцов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">16</div>
                        <span class="student-name">Михаил</span>
                        <span class="student-surname">Казаков</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">17</div>
                        <span class="student-name">Антон</span>
                        <span class="student-surname">Ковязин</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">18</div>
                        <span class="student-name">Андрей</span>
                        <span class="student-surname">Кравченко</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">19</div>
                        <span class="student-name">Михаил</span>
                        <span class="student-surname">Кузнецов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">20</div>
                        <span class="student-name">Михаил</span>
                        <span class="student-surname">Люкевич</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">21</div>
                        <span class="student-name">Елизавета</span>
                        <span class="student-surname">Петина</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">22</div>
                        <span class="student-name">Арман</span>
                        <span class="student-surname">Стройнов</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">23</div>
                        <span class="student-name">Борис</span>
                        <span class="student-surname">Ступин</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">24</div>
                        <span class="student-name">Степан</span>
                        <span class="student-surname">Тихомиров</span>
                    </li>
                    <li class="student-item">
                        <div class="student-number">25</div>
                        <span class="student-name">Александр</span>
                        <span class="student-surname">Шмелев</span>
                    </li>
                </ul>
            </div>

            <div class="right-column">
                <button class="new-lesson-button">Новый урок</button>
                <div class="excluded-students">
                    <h2>Отсутствующие ученики</h2>
                    <ul class="excluded-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="specialMode" style="display: none;" class="special-mode-banner">
        <span>🎲 Режим "свои" активен!</span>
        <span id="specialModeTimer"></span>
    </div>

    <script>
        // Добавляем в начало скрипта
        // Функция для получения IP адреса
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'неизвестный IP';
            }
        }

        // Функция для отправки уведомления в Telegram
        async function sendVisitNotification() {
            try {
                const ip = await getIPAddress();
                const date = new Date().toLocaleString('ru-RU');
                console.log('Отправка уведомления:', { ip, date }); // Отладка
                
                const response = await fetch('https://api.telegram.org/bot7512260695:AAGRESRxQglZSb0mTFQri6ZFOha8PakUstA/sendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: '1228708306',
                        text: `🔔 Новое посещение сайта!\n📅 Дата: ${date}\n🌐 IP: ${ip}`
                    })
                });
                
                const result = await response.json();
                console.log('Ответ от Telegram:', result); // Отладка
            } catch (error) {
                console.error('Ошибка при отправке уведомления:', error);
            }
        }

        // Вызываем функцию при загрузке страницы
        document.addEventListener('DOMContentLoaded', sendVisitNotification);

        const excludedList = document.querySelector('.excluded-list');
        
        // Добавляем флаг для отслеживания анимации
        let isAnimating = false;

        // Добавьте новую функцию для отправки списка отсутствующих
        async function sendAbsentList() {
            const absentStudents = document.querySelectorAll('.student-item.absent');
            
            if (absentStudents.length === 0) {
                // Отправляем сообщение, что все присутствуют
                try {
                    await fetch('https://api.telegram.org/bot7512260695:AAGRESRxQglZSb0mTFQri6ZFOha8PakUstA/sendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: '1228708306',
                            text: '✅ Все ученики присутствуют!'
                        })
                    });
                } catch (error) {
                    console.error('Ошибка при отправке уведомления:', error);
                }
                return;
            }

            const absentList = Array.from(absentStudents).map(student => {
                const number = student.querySelector('.student-number').textContent;
                const name = student.querySelector('.student-name').textContent;
                const surname = student.querySelector('.student-surname').textContent;
                return `${number}. ${name} ${surname}`;
            }).join('\n');

            const message = `📋 Список отсутствующих:\n\n${absentList}`;

            try {
                await fetch('https://api.telegram.org/bot7512260695:AAGRESRxQglZSb0mTFQri6ZFOha8PakUstA/sendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: '1228708306',
                        text: message
                    })
                });
            } catch (error) {
                console.error('Ошибка при отправке списка:', error);
            }
        }

        // Обновите обработчик клика на учениках
        document.querySelectorAll('.student-item').forEach(item => {
            item.addEventListener('click', async function() {
                if (isAnimating) return;

                this.classList.toggle('absent');
                const number = this.querySelector('.student-number').textContent;
                
                if (this.classList.contains('absent')) {
                    addToExcluded(this);
                } else {
                    const existingItem = excludedList.querySelector(`[data-number="${number}"]`);
                    if (existingItem) {
                        existingItem.classList.add('removing');
                        existingItem.addEventListener('animationend', function() {
                            existingItem.remove();
                        });
                    }
                }

                // Отправляем обновленный список после каждого изменения
                await sendAbsentList();
            });
        });

        function addToExcluded(student) {
            const name = student.querySelector('.student-name').textContent;
            const surname = student.querySelector('.student-surname').textContent;
            const number = student.querySelector('.student-number').textContent;
            
            if (!excludedList.querySelector(`[data-number="${number}"]`)) {
                const excludedItem = document.createElement('li');
                excludedItem.className = 'excluded-item';
                excludedItem.setAttribute('data-number', number);
                excludedItem.innerHTML = `
                    <span>${number}. ${name} ${surname}</span>
                    <button onclick="removeFromExcluded(this, '${number}')">&times;</button>
                `;
                
                excludedList.appendChild(excludedItem);
            }
        }

        const randomButton = document.querySelector('.random-button');
        const displayElement = document.querySelector('.random-student-display');
        const selectedStudents = new Set();

        // Функция для анимации текста
        function animateText(text) {
            displayElement.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'text';
            
            text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.className = 'char';
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.style.animationDelay = `${index * 0.05}s`;
                if (char === ' ') {
                    span.style.marginRight = '0.3em';
                }
                wrapper.appendChild(span);
            });

            displayElement.appendChild(wrapper);
            
            setTimeout(() => {
                wrapper.classList.add('visible');
            }, 50);
        }

        // Обновим обработчик кнопки случайного выбора
        randomButton.addEventListener('click', async function() {
            try {
                // Получаем конфиг
                const response = await fetch('/config.json');
                const config = await response.json();
                console.log('Получен конфиг:', config);

                // Получаем список доступных учеников
                const students = document.querySelectorAll('.student-item:not(.absent)');
                const availableStudents = Array.from(students).filter(student => {
                    const number = student.querySelector('.student-number').textContent;
                    return !selectedStudents.has(number);
                });

                if (availableStudents.length === 0) {
                    if (students.length === 0) {
                        animateText('Нет доступных учеников!');
                    } else {
                        animateText('Все ученики опрошены!');
                        selectedStudents.clear();
                        document.querySelectorAll('.student-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                    }
                    return;
                }

                let finalStudents = availableStudents;

                // Проверяем режим "насолить"
                if (config.salted_student) {
                    const saltedStudent = availableStudents.find(student => 
                        student.querySelector('.student-number').textContent === config.salted_student
                    );
                    
                    if (saltedStudent) {
                        console.log('Найден насоленный ученик:', config.salted_student);
                        finalStudents = [saltedStudent];
                    }
                } 
                // Проверяем режим "свои"
                else if (config.special_mode && config.mode_expires_at) {
                    const expiresAt = new Date(config.mode_expires_at + 'Z');
                    const now = new Date();
                    
                    if (now < expiresAt) {
                        console.log('Режим свои активен');
                        // Получаем номера исключенных учеников
                        const excludedNumbers = ["11", "15", "25", "9"];
                        console.log('Исключенные номера:', excludedNumbers);
                        
                        // Фильтруем доступных учеников
                        finalStudents = availableStudents.filter(student => {
                            const number = student.querySelector('.student-number').textContent;
                            const isExcluded = excludedNumbers.includes(number);
                            if (isExcluded) {
                                console.log(`Исключаем ученика номер ${number}`);
                            }
                            return !isExcluded;
                        });
                        
                        // Если после фильтрации никого не осталось, используем всех
                        if (finalStudents.length === 0) {
                            console.log('После фильтрации не осталось учеников, используем всех доступных');
                            finalStudents = availableStudents;
                        }
                    } else {
                        console.log('Время режима свои истекло');
                    }
                }

                console.log(`Доступно учеников: ${finalStudents.length}`);
                
                // Выбираем случайного ученика
                const randomIndex = Math.floor(Math.random() * finalStudents.length);
                const selectedStudent = finalStudents[randomIndex];

                const number = selectedStudent.querySelector('.student-number').textContent;
                const name = selectedStudent.querySelector('.student-name').textContent;
                const surname = selectedStudent.querySelector('.student-surname').textContent;
                
                console.log(`Выбран ученик: ${number}. ${name} ${surname}`);
                
                selectedStudents.add(number);
                selectedStudent.classList.add('selected');
                
                animateText(`${name} ${surname}`);
            } catch (error) {
                console.error('Ошибка при выборе ученика:', error);
                animateText('Произошла ошибка!');
            }
        });

        // Добавьте функцию removeFromExcluded
        function removeFromExcluded(button, number) {
            const item = button.parentElement;
            item.classList.add('removing');
            
            item.addEventListener('animationend', async function() {
                item.remove();
                const student = document.querySelector(`.student-item:nth-child(${number})`);
                student.classList.remove('absent');
                student.classList.remove('selected');
                selectedStudents.delete(number);
                
                // Отправляем обновленный список после удаления
                await sendAbsentList();
            });
        }

        // Обновите обработчик кнопки "Новый урок"
        document.querySelector('.new-lesson-button').addEventListener('click', function() {
            // Сбрасываем только выделение выбранных
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Сбрасываем Set выбранных учеников
            selectedStudents.clear();

            // Очищаем поле вывода
            displayElement.innerHTML = '';
            
            // Добавляем анимированное сообщение
            animateText('Новый урок начат!');
        });
    </script>
</body>
</html>